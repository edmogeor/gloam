From: gloam <gloam@patch>
Subject: [PATCH] lookandfeel: don't apply theme on schedule/config refresh

When KNightTime emits a schedule change (e.g. from a GeoClue position
update) or when config keys are written (AutomaticLookAndFeel,
Default*LookAndFeel), the autoswitcher was calling
rescheduleAndUpdateAuto/Now() which both updates the timer AND
force-applies the schedule-correct theme.  This overrides any manual
light/dark toggle the user made.

Change the scheduleChanged handler and reconfigure() to only call
reschedule(), which updates the timer to the new transition boundary
without touching the current theme.  The theme is still applied:
  - when the timer fires at an actual transition boundary
  - on clock skew (rescheduleAndUpdateNow)

Also adds a marker symbol (gloam_autoswitcher_patched) so the patch
can be detected at runtime via nm.

---
 kcms/lookandfeel/kded/lookandfeelautoswitcher.cpp | 14 ++++++++++----
 1 file changed, 10 insertions(+), 4 deletions(-)

diff --git a/kcms/lookandfeel/kded/lookandfeelautoswitcher.cpp b/kcms/lookandfeel/kded/lookandfeelautoswitcher.cpp
--- a/kcms/lookandfeel/kded/lookandfeelautoswitcher.cpp
+++ b/kcms/lookandfeel/kded/lookandfeelautoswitcher.cpp
@@ -85,14 +85,22 @@
                 m_state->setSerializedSchedule(m_scheduleProvider->state());
                 m_state->save();

-                rescheduleAndUpdateAuto();
+                // Only update the timer — don't reapply the theme, which
+                // would override any manual light/dark toggle.
+                reschedule();
             });
         }

-        rescheduleAndUpdateNow();
+        // Only set up the timer — don't apply the theme now, so that
+        // writing AutomaticLookAndFeel / Default*LookAndFeel to kdeglobals
+        // doesn't override the current theme.
+        reschedule();
     }
 }

+// Marker symbol for gloam patch detection via nm
+extern "C" { int gloam_autoswitcher_patched = 1; }
+
 QString LookAndFeelAutoSwitcher::lookAndFeelAtDateTime(const QDateTime &dateTime) const
 {
     switch (m_previousTransition->test(dateTime)) {
